// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id // Clerk ID
  email     String   @unique
  name      String?
  phone     String?
  nif       String?
  address   String?
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  
  invoices  Invoice[]

  // LOYALTY SYSTEM (Controlled by Groomer or Auto-calculated)
  loyaltyPoints Int      @default(0) // e.g. 9 points. At 10, gets coupon.
  
  appointments Appointment[]
  pets         Pet[]
  coupons      Coupon[]
}

model Pet {
  id              String   @id @default(cuid())
  name            String
  species         Species  @default(DOG) // DOG, CAT, RABBIT
  breed           String?
  birthDate       DateTime?
  gender          String?
  microchip       String?
  
  // FOR PRICING CALCULATIONS
  sizeCategory    PetSize?    // <5kg, 5-10kg, etc.
  coatType        CoatType?   // SHORT, MEDIUM, LONG
  
  // Health Flags
  allergies       String?   @db.Text
  skinIssues      String?   @db.Text
  heartIssues     String?   @db.Text
  medicalNotes    String?   @db.Text 

  userId          String
  user            User     @relation(fields: [userId], references: [id])
  appointments    Appointment[]
}

model Service {
  id          String   @id @default(cuid())
  name        String   // e.g. "Banho + Tosquia Higiénica"
  description String?  // e.g. "Includes nail trimming, ears..."
  category    ServiceCategory // GROOMING, HYGIENE, EXOTIC, SPA
  
  // Does this service allow Add-ons? (Like Masks)
  allowsAddOns Boolean @default(false)
  isMobileAvailable Boolean @default(false) // NEW: Available for mobile service

  // Link to the Price Matrix
  options     ServiceOption[]
  
  appointments Appointment[]
}

model ServiceOption {
  id          String   @id @default(cuid())
  
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  // The Conditions
  petSize     PetSize?   // If null, applies to all sizes (e.g. for Cats)
  coatType    CoatType?  // If null, applies to all coats
  
  // The Result
  price       Decimal
  durationMin Int
  durationMax Int?
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String?       @unique // Will be generated on Issue (e.g. FT 2025/1)
  date          DateTime      @default(now())
  
  subtotal      Decimal
  taxAmount     Decimal       @default(0)
  totalAmount   Decimal
  
  status        InvoiceStatus @default(DRAFT)
  
  externalId    String?       // Moloni ID
  pdfUrl        String?
  
  appointmentId String        @unique
  appointment   Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  userId        String
  user          User          @relation(fields: [userId], references: [id])
}

model ExtraFee {
  id          String                @id @default(cuid())
  name        String                // "Taxa de Nós"
  basePrice   Decimal
  category    ExtraFeeCategory      @default(MANEJO)
  appointments AppointmentExtraFee[]
}

model AppointmentExtraFee {
  id            String      @id @default(cuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  extraFeeId    String
  extraFee      ExtraFee    @relation(fields: [extraFeeId], references: [id])

  quantity      Int         @default(1)
  appliedPrice  Decimal
  notes         String?
}

model Appointment {
  id        String   @id @default(cuid())
  date      DateTime
  status    String   @default("PENDING")
  
  // Financials
  price         Decimal  
  originalPrice Decimal? 
  discountNotes String?
  isPaid        Boolean       @default(false)
  paymentMethod PaymentMethod?
  paidAt        DateTime?

  // Location / Mobile Service
  locationType  LocationType  @default(SALON)
  mobileAddress String?       // Address if MOBILE
  travelFee     Decimal       @default(0) // Separate fee for travel

  // Operations (NEW)
  actualStartTime DateTime? 
  actualEndTime   DateTime? 
  finishedAt      DateTime? 
  collectedAt     DateTime? 
  behaviorNotes   String?   @db.Text 

  invoice         Invoice?
  extraFees       AppointmentExtraFee[]

  // Medical/Behavior (Same as before)
  v7Updated          Boolean @default(false)
  rabiesUpdated      Boolean @default(false)
  kennelCoughUpdated Boolean @default(false)
  internalDeworming  Boolean @default(false)
  externalDeworming  Boolean @default(false)
  socialPeople       SocialRating @default(UNKNOWN)
  socialDogs         SocialRating @default(UNKNOWN)
  fearDryer          Boolean      @default(false)
  fearClippers       Boolean      @default(false)
  fearBathing        Boolean      @default(false)
  stressLevel        StressLevel  @default(LOW)
  groomerNotes       String?      @db.Text

  // Relations
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id])
  
  // Main Service
  serviceId String
  service   Service  @relation(fields: [serviceId], references: [id])

  // NEW: Porosity Test Results / Treatments used
  spaTreatment  String? // e.g., "Mascara de Hidratação"

}

enum Species {
  DOG
  CAT
  RABBIT
  OTHER
}

enum ServiceCategory {
  GROOMING // Shaving, Cuts (1, 2, 4, 5, 12)
  HYGIENE  // Nails, Ears, Higienic Shave (3, 7, 8, 9, 10, 11, 13)
  EXOTIC   // Cats & Rabbits (6)
  SPA      // Porosity, Masks (14)
}

enum PetSize {
  TOY           // < 5kg
  SMALL         // 5 - 10kg
  MEDIUM        // 11 - 20kg
  LARGE         // 21 - 30kg
  XL            // 31 - 40kg
  GIANT         // > 40kg
}

enum CoatType {
  SHORT
  MEDIUM
  LONG
}

model Expense {
  id          String   @id @default(cuid())
  description String   // e.g. "Shampoo 5L", "Luz", "Internet"
  amount      Decimal
  date        DateTime @default(now())
  
  category    ExpenseCategory @default(PRODUCT)
  
  notes       String?  @db.Text
}

model Coupon {
  id        String   @id @default(cuid())
  code      String   @unique
  discount  Int      // Percentage (e.g. 100) or Fixed Amount? usually % based on context.
  active    Boolean  @default(true)
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  usedAt    DateTime?
}

enum PaymentMethod {
  CASH
  MBWAY
  CARD
  TRANSFER
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  CANCELLED
  PAID
}

enum ExtraFeeCategory {
  MANEJO
  PELO
  LOGISTICA
  OUTRO
}

enum ExpenseCategory {
  PRODUCT     // Shampoos, perfumes
  EQUIPMENT   // Scissors, tables
  UTILITIES   // Water, Light, Internet
  RENT        // Shop rent
  TAXES       // Finanças
  OTHER
}

enum SocialRating {
  GOOD
  MEDIUM
  DIFFICULT
  UNKNOWN
}

enum StressLevel {
  LOW
  MEDIUM
  HIGH
}



enum LocationType {
  SALON
  MOBILE
}

model BusinessSettings {
  id              String   @id @default("default") // Singleton pattern usually, or just use 1st row
  
  // Base Location (Salon)
  baseLatitude    Float    @default(40.5489) // Tondela approx
  baseLongitude   Float    @default(-8.0815) // Tondela approx
  baseAddress     String?

  // Zone 1
  zone1RadiusKm   Float    @default(5)
  zone1Fee        Decimal  @default(0)

  // Zone 2
  zone2RadiusKm   Float    @default(10)
  zone2Fee        Decimal  @default(10)

  // Zone 3 / Limit
  zone3Fee        Decimal  @default(15) // Fee for area between Zone 2 and Max Radius
  maxRadiusKm     Float    @default(20)

  updatedAt       DateTime @updatedAt
}
